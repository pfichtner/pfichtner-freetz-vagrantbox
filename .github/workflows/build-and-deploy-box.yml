name: Build, Export, and Release VirtualBox Image

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-10.15
    steps:
    - uses: actions/checkout@v2
    - name: Create virtual machine using vagrant
      run: |
        cd alpine && vagrant up --provider virtualbox
    - name: Shutdown virtual machine
      run: |
        cd alpine && vagrant halt
    - name: Export virtual machine to OVA
      run: |
        cd alpine && packer build -var 'vm_name=pfichtner-freetzg-buildsystem' -var 'output_directory=ovaexport' vagrantbox2ova.json
    - name: Destroy virtual machine
      run: |
        cd alpine && vagrant destroy -f
    - name: Release OVA
      uses: actions/upload-artifact@v2
      with:
        name: pfichtner-freetz-vagrantbox.box
        path: alpine/ovaexport/pfichtner-freetzg-buildsystem.ova
