name: Build, Export, and Release VirtualBox Image

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install Virtualbox and Vagrant
      run: |
        sudo apt-get update
        sudo apt-get install -y virtualbox vagrant
    - name: Generate VirtualBox Image
      run: |
        cd alpine && vagrant up --provider virtualbox
    - name: Export VirtualBox Image
      run: |
        cd alpine && packer build -var 'vm_name=pfichtner-freetzg-buildsystem' -var 'output_directory=ovaexport' vagrantbox2ova.json
    - name: Destroy machine
      run: |
        cd alpine && vagrant destroy -f
    - name: Release VirtualBox Image
      uses: actions/upload-artifact@v2
      with:
        name: pfichtner-freetz-vagrantbox.box
        path: alpine/ovaexport/pfichtner-freetzg-buildsystem.ova
